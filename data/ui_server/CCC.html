<!DOCTYPE html>
<html>
<head>
    <title>Cell Count Calibration</title>
    <meta charset="utf-8" />
    <script src="js/jquery-2.2.3.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/d3.js"></script>
    <script src="js/cccAPIHelper.js"></script>
    <script src="js/CCCHelper.js"></script>

    <link href="style/ccc.css" rel="stylesheet" />
    <link href="style/bootstrap.css" rel="stylesheet" />
    <link href="style/main.css" rel="stylesheet" />
    <link href="style/jquery-ui.css" rel="stylesheet" />
</head>
<body>
    <script>
        $(document)
            .ready(function () {
                var selFixtureName = "selFixtures";
                var selPinFormatsName = "selPinFormats";
                var uploads = [];

                function processMarkers(markers) {
                    var markerXcoords = [];
                    var markerYcoords = [];
                    for (var i = 0; i < markers.length; i++) {
                        markerXcoords.push(markers[i][0]);
                        markerYcoords.push(markers[i][1]);
                    }
                    var postMarkers = [];
                    postMarkers.push(markerXcoords);
                    postMarkers.push(markerYcoords);
                    return JSON.stringify(postMarkers);
                }

                function getImageIdSuccess(data)
                {
                    if (data.success)
                        alert("success uploading!");
                }
                function getImageIdError(data)
                {
                    if (!data.success)
                        alert("error uploading!");
                }

                $("#btnUploadImage").click(function () {
                    var fixtureName = $("#" + selFixtureName + " option:selected").text();
                    var file = $("#imageUpload")[0].files[0];
                    if (!file) {
                        alert("You need to select a valid file!");
                        return;
                    }
                    var uploadedFile = { file: file, markers: {}, plates: {}, grayScale: {} };
                    uploads.push(uploadedFile);
                    GetMarkers(fixtureName, file, function (data) {
                        if (data.success == true) {
                            alert("The marker data was uploaded successfully:");
                            var uploadedFile = uploads[0];
                            uploadedFile.markers = data.markers;
                            var postMarkers = processMarkers(data.markers);
                            //here is the problem
                            GetImageId("YESTIS", file, "2347cf00d8af11e6b545e069955c1a98", getImageIdSuccess, getImageIdError);
                        } else
                            alert("There was a problem with the upload: " + data.reason);
                    },
                    function (data) {
                        alert("error:" + data.responseText);
                    });
                });

                function ini() {
                    GetFixtures(function (fixtures) {
                        if (fixtures == null) {
                            alert("ERROR: There was a problem with the API while fecthing fixtures!");
                            return;
                        }
                        var elementName = selFixtureName;
                        d3.select("#" + elementName).remove();
                        var selPhen = d3.select("#divFixtureSelector")
                            .append("select")
                            .attr("id", elementName);
                        var options = selPhen.selectAll("optionPlaceholders")
                            .data(fixtures)
                            .enter()
                            .append("option");
                        options.attr("value", function (d) { return d; });
                        options.text(function (d) { return d; });
                        $("#" + elementName).selectedIndex = 0;
                    });

                    GetPinningFormats(function (formats) {
                        if (formats == null) {
                            alert("ERROR: There was a problem with the API while fetching pinnnig formats! ");
                            return;
                        }
                        var elementName = selPinFormatsName;
                        d3.select("#" + elementName).remove();
                        var selPhen = d3.select("#divPinningFormatsSelector")
                            .append("select")
                            .attr("id", elementName);
                        var options = selPhen.selectAll("optionPlaceholders")
                            .data(formats)
                            .enter()
                            .append("option");
                        options.attr("value", function (d) { return d.value; });
                        options.text(function (d) { return d.name; });
                        $("#" + elementName).selectedIndex = 0;
                    });
                };

                ini();

                var dialog;
                var form;
                var species = $("#inSpecies");
                var reference = $("#inReference");
                var allFields = $([]).add(species).add(reference);
                var tips = $(".validateTips");

                function updateTips(t) {
                    tips.text(t).addClass("ui-state-highlight");
                    setTimeout(function () {
                        tips.removeClass("ui-state-highlight", 1500);
                    }, 500);
                }

                function checkLength(o, n, min, max) {
                    if (o.val().length > max || o.val().length < min) {
                        o.addClass("ui-state-error");
                        updateTips("Length of " + n + " must be between " +
                            min + " and " + max + ".");
                        return false;
                    } else {
                        return true;
                    }
                }

                function checkRegexp(o, regexp, n) {
                    if (!(regexp.test(o.val()))) {
                        o.addClass("ui-state-error");
                        updateTips(n);
                        return false;
                    } else {
                        return true;
                    }
                };

                function initiateNewCCC() {
                    var valid = true;
                    allFields.removeClass("ui-state-error");

                    valid = valid && checkLength(species, "species", 3, 20);
                    valid = valid && checkLength(reference, "reference", 3, 20);

                    valid = valid && checkRegexp(species, /^[a-z]([0-9a-z_\s])+$/i, "This field may consist of a-z, 0-9, underscores, spaces and must begin with a letter.");
                    valid = valid && checkRegexp(reference, /^[a-z]([0-9a-z_\s])+$/i, "This field may consist of a-z, 0-9, underscores, spaces and must begin with a letter.");

                    if (valid) {
                        InitiateCCC(species.val(), reference.val(),
                            function(data) {
                                if (data.success) {
                                    var id = data.identifier;
                                    var token = data.access_token;
                                    $("#inititated-cccs tbody").append("<tr>" +
                                        "<td>" + id + " " + token + "</td>" +
                                        "<td>" + species.val() + "</td>" +
                                        "<td>" + reference.val() + "</td>" +
                                    "</tr>");
                                } else {
                                    alert("Problem initializing");
                                }
                            },
                            function(data) {
                                alert("ini failure!");
                            });

                        $("#inititated-cccs tbody").append("<tr>" +
                            "<td>" + "-" + "</td>" +
                            "<td>" + species.val() + "</td>" +
                            "<td>" + reference.val() + "</td>" +
                        "</tr>");
                        dialog.dialog("close");
                    }
                    return valid;
                }

                dialog = $("#dialog-form").dialog({
                    autoOpen: false,
                    height: 400,
                    width: 350,
                    modal: true,
                    buttons: {
                        "Initiate new CCC": initiateNewCCC,
                        Cancel: function () { dialog.dialog("close"); }
                    },
                    close: function () {
                        form[0].reset();
                        allFields.removeClass("ui-state-error");
                    }
                });

                form = dialog.find("form").on("submit", function (event) {
                    event.preventDefault();
                    initiateNewCCC();
                });

                $("#initiate-ccc").button().on("click", function () {
                    dialog.dialog("open");
                });


            });
    </script>
    <div id="cont" class="container QCCont">
        <h1>Cell Count Calibration</h1>
        <h2>Selection</h2>
        <div class="section-frame">
            <div class="row" style="visibility:collapse">
                <div class="col-md-12 " style="height: 100%; width: 100%">
                    <div class="floating-box" style="width: 20%; horiz-align: center">
                        <div id="dialog-form" title="Initiate new CCC">
                            <p class="validateTips">All form fields are required.</p>
                            <form>
                                <fieldset>
                                    <label for="inSpecies">Species</label>
                                    <input type="text" name="inSpecies" id="inSpecies" value="Name of you species" class="text ui-widget-content ui-corner-all">
                                    <label for="inReference">Reference/Contact</label>
                                    <input type="text" name="inReference" id="inReference" value="reference or contact" class="text ui-widget-content ui-corner-all">
                                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                                </fieldset>
                            </form>
                        </div>
                        <div id="ccc-contain" class="ui-widget">
                            <h1>Initiated CCCs:</h1>
                            <table id="inititated-cccs" class="ui-widget ui-widget-content">
                                <thead>
                                    <tr class="ui-widget-header ">
                                        <th>Identifiers</th>
                                        <th>Specie</th>
                                        <th>Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button id="initiate-ccc">Initiate new CCC</button>
                    </div>
                </div>
            </div>

            <div class="row" >
                <div class="col-md-12 " style="height: 100%; width: 100%">
                    <div class="floating-box" style="width: 20%; horiz-align: center">
                        <div style="margin-left: 10px; float: left" id="divFixtureSelector"></div>
                        <div style="margin-left: 10px; float: left" id="divPinningFormatsSelector"></div>
                    </div>
                </div>
            </div>
            <div class="section-frame" >
                <div class="row">
                    <div class="col-md-12">
                        <input type="file" name="imageUpload" id="imageUpload" accept="image/*" />
                        <button id="btnUploadImage" class="btn btn-default btn-xs">Upload</button>
                    </div>
                </div>
            </div>
            <table style="visibility:collapse">
                <tr>
                    <td>Image Slice</td>
                    <td><img id="imgSlice" /></td>
                </tr>
            </table>


        </div>
    </div>
</body>



</html>
